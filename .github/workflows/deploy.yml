name: Deploy environment
on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set SSH info
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
            chmod 600 ~/.ssh/id_rsa
            chmod 644 ~/.ssh/known_hosts
      - name: Run deployment script
        env:
          HOST: ${{ secrets.SSH_HOST }}
        run: |
            ssh -i ~/.ssh/id_rsa $HOST "cd ~/bed/${{github.ref_name}} && git pull && git checkout ${{github.ref_name}} && docker compose -f compose.yml up -d --build && docker compose -f compose.yml exec backend pnpm run migrate"